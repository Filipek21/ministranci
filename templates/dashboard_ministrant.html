<!DOCTYPE html>
<html>
<head>
<title>Panel Ministranta</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
  <h1>Panel Ministranta: {{ user }}</h1>
  <div class="user-menu">
    <button onclick="toggleChangePassword()">Zmiana hasÅ‚a</button>
    <a href="/logout" class="logout-btn">Wyloguj</a>
  </div>
</header>

<nav>
  <a href="#punkty">Moje punkty</a>
  <a href="#harmonogram">Dzisiejsze msze</a>
  <a href="#statystyki">Statystyki</a>
  <a href="#ogloszenia">OgÅ‚oszenia</a>
  <a href="#wiadomosci">WiadomoÅ›ci</a>
</nav>

<!-- Modal zmiany hasÅ‚a -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="toggleChangePassword()">&times;</span>
    <h3>Zmiana hasÅ‚a</h3>
    <form id="changePasswordForm">
      <input type="password" name="current_password" placeholder="Obecne hasÅ‚o" required>
      <input type="password" name="new_password" placeholder="Nowe hasÅ‚o" required>
      <button type="submit">ZmieÅ„ hasÅ‚o</button>
    </form>
    <div id="passwordMessage"></div>
  </div>
</div>

<section id="punkty">
  <h2>Moje punkty</h2>
  
  <div class="season-info">
    <h3>Aktualny sezon punktÃ³w</h3>
    {% if current_season %}
    <div class="season-card">
      <p><strong>{{ current_season[1] }}</strong></p>
      <p>Od: {{ current_season[2] }} Do: {{ current_season[3] }}</p>
    </div>
    {% else %}
    <p>Brak aktywnego sezonu punktÃ³w.</p>
    {% endif %}
  </div>
  
  <div class="attendance-card">
    <h3>Zaznacz obecnoÅ›Ä‡ na mszy</h3>
    <form method="POST">
      <label>Wybierz mszÄ™ z harmonogramu:</label>
      <select name="mass_schedule_id" required>
        <option value="">-- Wybierz mszÄ™ --</option>
        {% if available_masses %}
          {% for mass in available_masses %}
          <option value="{{ mass[0] | string }}">{{ mass[1] }} o {{ mass[2] }} - {{ mass[3] }}</option>
          {% endfor %}
        {% else %}
          <option value="1">Brak dostÄ™pnych mszy (ID: 1)</option>
        {% endif %}
      </select>
      <label>Uwagi (opcjonalnie):</label>
      <textarea name="uwagi" placeholder="Dodatkowe uwagi..."></textarea>
      <button type="submit">Zaznacz obecnoÅ›Ä‡</button>
    </form>
    <div class="points-info">
      <p><strong>Informacja o punktach:</strong></p>
      <ul>
        <li>Za pierwszÄ… mszÄ™ w tygodniu (od poniedziaÅ‚ku do soboty) otrzymujesz <strong>1 punkt</strong></li>
        <li>Za drugÄ… i kaÅ¼dÄ… kolejnÄ… mszÄ™ w tygodniu otrzymujesz <strong>2 punkty</strong></li>
        <li>Wszystkie punkty wymagajÄ… akceptacji przez ksiÄ™dza lub admina</li>
      </ul>
    </div>
  </div>

  <div class="filters">
    <h3>Filtruj historiÄ™</h3>
    <form method="GET">
      <label>TydzieÅ„ od:</label>
      <input type="date" name="week_start">
      <label>MiesiÄ…c:</label>
      <input type="month" name="month">
      <button type="submit">Filtruj</button>
      <a href="?">WyczyÅ›Ä‡ filtry</a>
    </form>
  </div>

  <div class="stats-summary">
    <p><strong>ÅÄ…czna suma punktÃ³w: {{ stats.total }}</strong></p>
    <p>Punkty w tym miesiÄ…cu: {{ stats.monthly }} ({{ stats.count_monthly }} obecnoÅ›ci)</p>
    {% if stats.rank %}
    <p>Twoje miejsce w rankingu: {{ stats.rank }} z {{ stats.total_users }}</p>
    {% endif %}
  </div>

  <table>
    <tr>
      <th>Data</th>
      <th>Punkty</th>
      <th>Typ mszy</th>
      <th>Uwagi</th>
      <th>Status</th>
      <th>DzieÅ„ tygodnia</th>
    </tr>
    {% for r in records %}
    <tr class="points-{{ r[1] }} status-{{ r[4] }}">
      <td>{{ r[0] }}</td>
      <td>{{ r[1] }}</td>
      <td class="mass-type-{{ r[2] }}">{{ r[2] }}</td>
      <td>{{ r[3] or '-' }}</td>
      <td>
        <span class="status-badge status-{{ r[4] }}">
          {% if r[4] == 'pending' %}OczekujÄ…ce
          {% elif r[4] == 'approved' %}Zaakceptowane
          {% elif r[4] == 'rejected' %}Odrzucone
          {% else %}{{ r[4] }}{% endif %}
        </span>
      </td>
      <td>
        {% set day_num = r[0].strftime('%w') %}
        {% if day_num == '0' %}Niedziela
        {% elif day_num == '1' %}PoniedziaÅ‚ek
        {% elif day_num == '2' %}Wtorek
        {% elif day_num == '3' %}Åšroda
        {% elif day_num == '4' %}Czwartek
        {% elif day_num == '5' %}PiÄ…tek
        {% elif day_num == '6' %}Sobota
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
</section>

<section id="harmonogram">
  <h2>Dzisiejsze msze</h2>
  {% if todays_masses %}
    <div class="mass-schedule">
      {% for mass in todays_masses %}
      <div class="mass-item">
        <h4>Godzina: {{ mass[0] }}</h4>
        <p>Typ: {{ mass[1] }}</p>
        <p>{{ mass[2] or 'Brak uwag' }}</p>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Brak zaplanowanych mszy na dziÅ›.</p>
  {% endif %}
</section>

<section id="statystyki">
  <h2>Moje statystyki</h2>
  <div class="stats-grid">
    <div class="stat-card">
      <h3>ÅÄ…cznie</h3>
      <p class="stat-number">{{ stats.total }}</p>
      <p>punktÃ³w</p>
    </div>
    <div class="stat-card">
      <h3>Ten miesiÄ…c</h3>
      <p class="stat-number">{{ stats.monthly }}</p>
      <p>punktÃ³w</p>
    </div>
    <div class="stat-card">
      <h3>ObecnoÅ›ci</h3>
      <p class="stat-number">{{ stats.count_monthly }}</p>
      <p>w tym miesiÄ…cu</p>
    </div>
    <div class="stat-card">
      <h3>Ranking</h3>
      <p class="stat-number">{{ stats.rank or '-' }}</p>
      <p>miejsce</p>
    </div>
  </div>
</section>

<section id="ogloszenia">
  <h2>OgÅ‚oszenia</h2>
  <div class="announcements-container">
    {% for o in announcements %}
    <div class="announcement {% if o[5] > 0 %}priority{% endif %}">
      <div class="announcement-header">
        <h3>{{ o[1] }}</h3>
        <span class="announcement-date">{{ o[3] }}</span>
      </div>
      <p>{{ o[2] }}</p>
      <div class="announcement-footer">
        <small>Autor: {{ o[4] }}</small>
        {% if o[5] > 0 %}
        <span class="priority-badge">WAÅ»NE</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<section id="wiadomosci">
  <h2>ğŸ’¬ Rozmowy - Czat z ksiÄ™dzem/administratorem</h2>
  <div style="display:grid; grid-template-columns: 300px 1fr; gap: 20px; height:calc(100vh - 200px);">
    <div class="conversations-list" style="background:#2a2a2a; padding:15px; border-radius:8px; overflow-y:auto; border:1px solid #444; min-height:0;">
      <h3 style="margin-top:0; color:#2196F3; font-size:16px;">ğŸ“¬ Nowa rozmowa</h3>
      <form onsubmit="startConv(event)" style="margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #555;">
        <label style="color:#fff; font-weight:600; font-size:13px;">Wybierz odborcÄ™:</label>
        <select id="odbiorcy" required style="width:100%; padding:8px; background:#1a1a1a; color:#fff; border:1px solid #555; border-radius:4px; margin:8px 0; font-size:13px;">
          <option value="">-- Wybierz --</option>
          {% for u in all_users %}
            {% if u[1] in ['ksiez', 'admin'] %}
            <option value="{{ u[0] }}">{{ u[0] }} ({{ u[1] }})</option>
            {% endif %}
          {% endfor %}
        </select>
        <button type="submit" style="width:100%; padding:10px; background:#4CAF50; color:#fff; border:none; border-radius:4px; font-weight:600; cursor:pointer; font-size:13px;">â• Nowa rozmowa</button>
      </form>
      <h3 style="margin:0 0 10px 0; color:#2196F3; font-size:16px;">ğŸ“‹ Rozmowy</h3>
      <div id="convList" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
    <div class="chat-window" style="background:#2a2a2a; border-radius:8px; border:1px solid #444; display:flex; flex-direction:column; min-height:0;">
      <div id="noConvSelected" style="flex:1; display:flex; align-items:center; justify-content:center; text-align:center; padding:20px; color:#aaa; font-size:16px;">
        â† Zacznij lub wybierz rozmowÄ™
      </div>
      <div id="chatBox" style="display:none; flex:1; display:flex; flex-direction:column; min-height:0;">
        <div style="background:#1a1a1a; padding:15px; border-bottom:1px solid #444;">
          <h3 id="chatTitle" style="margin:0; color:#2196F3; font-size:18px;"></h3>
        </div>
        <div id="messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; min-height:0;"></div>
        <form onsubmit="sendMsg(event)" style="background:#1a1a1a; padding:15px; border-top:1px solid #444; display:flex; flex-direction:column; gap:10px; flex-shrink:0;">
          <textarea id="msgInput" placeholder="ğŸ’­ Wpisz wiadomoÅ›Ä‡... (Enter+Ctrl aby wysÅ‚aÄ‡)" required style="width:100%; min-height:150px; padding:12px; background:#2a2a2a; color:#fff; border:1px solid #555; border-radius:4px; resize:vertical; font-size:14px; font-family:Arial,sans-serif; box-sizing:border-box;"></textarea>
          <button type="submit" class="btn" style="align-self:flex-end; padding:10px 20px; font-size:13px; background:#4CAF50; color:#fff; font-weight:600; border:none; border-radius:4px; cursor:pointer;">ğŸ“¤ WyÅ›lij wiadomoÅ›Ä‡</button>
        </form>
      </div>
    </div>
  </div>
</section>

<section id="kary">
  <h2>Moje kary</h2>
  <div id="myPenalties" style="display:grid; gap:15px;">
    <p style="color:#b0b0b0;">Brak kar</p>
  </div>
</section>

<script>
// Poprawiona nawigacja miÄ™dzy sekcjami
document.addEventListener("DOMContentLoaded", function() {
    // Ukryj wszystkie sekcje na poczÄ…tku
    document.querySelectorAll("section").forEach(sec => {
        sec.style.display = "none";
    });
    
    // PokaÅ¼ pierwszÄ… sekcjÄ™ lub zapisanÄ… w sessionStorage
    const activeSection = sessionStorage.getItem('activeSection') || 'punkty';
    const targetSection = document.getElementById(activeSection);
    if (targetSection) {
        targetSection.style.display = "block";
    } else {
        const firstSection = document.querySelector("section");
        if (firstSection) {
            firstSection.style.display = "block";
        }
    }
});

// ObsÅ‚uga klikniÄ™cia w linki nawigacyjne
document.querySelectorAll("nav a").forEach(link => {
    link.addEventListener("click", function(e) {
        e.preventDefault();
        const targetId = this.getAttribute("href").substring(1);
        
        // Ukryj wszystkie sekcje
        document.querySelectorAll("section").forEach(sec => {
            sec.style.display = "none";
        });
        
        // PokaÅ¼ wybranÄ… sekcjÄ™
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
            targetSection.style.display = "block";
            sessionStorage.setItem('activeSection', targetId);
        }
    });
});

function toggleChangePassword() {
  const modal = document.getElementById('changePasswordModal');
  modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
}

document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  fetch('/change_my_password', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    const messageDiv = document.getElementById('passwordMessage');
    messageDiv.innerHTML = data.message;
    messageDiv.className = data.success ? 'success' : 'error';
    
    if (data.success) {
      setTimeout(() => {
        toggleChangePassword();
        messageDiv.innerHTML = '';
      }, 2000);
    }
  });
});
</script>
</body>
</html>

<script>
let currentConv = null;

async function startConv(e) {
  e.preventDefault();
  const odbiorcy = document.getElementById('odbiorcy').value;
  const fd = new FormData();
  fd.append('odbiorca', odbiorcy);
  const res = await fetch('/start_conversation', {method:'POST', body:fd});
  const data = await res.json();
  if(data.success) {
    currentConv = data.conversation_id;
    await loadConversations();
    document.getElementById('odbiorcy').value = '';
  } else {
    alert(data.error || 'Nie moÅ¼na rozpoczÄ…Ä‡ rozmowy');
  }
}

async function loadConversations() {
  const res = await fetch('/get_conversations');
  const convs = await res.json();
  const list = document.getElementById('convList');
  list.innerHTML = convs.map(c => `
    <div class="conv-item" onclick="openConv(${c.id}, '${c.odbiorca}', '${c.status}')" style="padding:10px; cursor:pointer; border:1px solid #ddd; margin:5px 0; border-radius:5px; background:${c.status=='closed'?'#f0f0f0':'#fff'}; font-weight:${currentConv==c.id?'bold':'normal'}">
      <strong>â†’ ${c.odbiorca}</strong><br/>
      <small>${c.status=='closed'?'ZAMKNIÄ˜TA':'Otwarta'}</small>
    </div>
  `).join('') || '<p>Brak rozmÃ³w</p>';
}

async function openConv(id, odbiorcy, status) {
  currentConv = id;
  document.getElementById('noConvSelected').style.display = 'none';
  document.getElementById('chatBox').style.display = 'block';
  document.getElementById('chatTitle').innerHTML = 'Rozmowa z ' + odbiorcy + (status=='closed'?' (ZAMKNIÄ˜TA)':'');
  await loadMessages();
}

async function loadMessages() {
  if(!currentConv) return;
  const res = await fetch('/get_conversation/' + currentConv);
  const msgs = await res.json();
  const box = document.getElementById('messages');
  box.innerHTML = msgs.map(m => `
    <div style="margin:5px 0; padding:8px; background:#f5f5f5; border-radius:3px;">
      <strong>${m.nadawca}:</strong> ${m.tresc}<br/>
      <small>${m.data}</small>
    </div>
  `).join('');
  box.scrollTop = box.scrollHeight;
}

async function sendMsg(e) {
  e.preventDefault();
  if(!currentConv) return;
  const text = document.getElementById('msgInput').value;
  if(!text) return;
  const fd = new FormData();
  fd.append('conversation_id', currentConv);
  fd.append('tresc', text);
  const res = await fetch('/send_message', {method:'POST', body:fd});
  const data = await res.json();
  if(data.success) {
    document.getElementById('msgInput').value = '';
    await loadMessages();
  }
}

loadConversations();
setInterval(loadConversations, 10000);
</script>
